<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tower Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="container mt-5">
    <h2 class="text-center">Tower Details</h2>
    <div class="table-responsive">
        <table class="table table-bordered table-striped">
            <thead class="table-dark">
                <tr>
                    <th>Tower ID</th>
                    <th>Height</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Location</th>
                    <th>Pincode</th>
                    <th>Latitude</th>
                    <th>Longitude</th>
                    <th>Power Reading</th>
                    <th>Fuel Reading</th>
                    <th>Created At</th>
                    <th>Updated At</th>
                    <th>Last Maintained</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="towerTableBody">
                <!-- Data will be injected here by JavaScript -->
            </tbody>
        </table>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTowerModal">Add Tower</button>
    </div>
</div>

<!-- Edit Tower Modal -->
<div class="modal fade" id="editTowerModal" tabindex="-1" aria-labelledby="editTowerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTowerModalLabel">Edit Tower Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTowerForm">
                    <input type="hidden" id="editTowerId">
                    <div class="mb-3">
                        <label for="editHeight" class="form-label">Height</label>
                        <input type="number" step="0.01" class="form-control" id="editHeight" required>
                    </div>
                    <div class="mb-3">
                        <label for="editType" class="form-label">Type</label>
                        <input type="text" class="form-control" id="editType" required>
                    </div>
                    <div class="mb-3">
                        <label for="editStatus" class="form-label">Status</label>
                        <input type="text" class="form-control" id="editStatus" required>
                    </div>
                    <div class="mb-3">
                        <label for="editLocation" class="form-label">Location</label>
                        <input type="text" class="form-control" id="editLocation" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPincode" class="form-label">Pincode</label>
                        <input type="number" class="form-control" id="editPincode" required>
                    </div>
                    <div class="mb-3">
                        <label for="editLatitude" class="form-label">Latitude</label>
                        <input type="number" step="0.0001" class="form-control" id="editLatitude" required>
                    </div>
                    <div class="mb-3">
                        <label for="editLongitude" class="form-label">Longitude</label>
                        <input type="number" step="0.0001" class="form-control" id="editLongitude" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPowerReading" class="form-label">Power Reading</label>
                        <input type="number" step="0.01" class="form-control" id="editPowerReading" required>
                    </div>
                    <div class="mb-3">
                        <label for="editFuelReading" class="form-label">Fuel Reading</label>
                        <input type="number" step="0.01" class="form-control" id="editFuelReading" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Tower Modal -->
<div class="modal fade" id="addTowerModal" tabindex="-1" aria-labelledby="addTowerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTowerModalLabel">Add Tower</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addTowerForm">
                    <div class="mb-3">
                        <label for="height" class="form-label">Height</label>
                        <input type="number" class="form-control" id="height" required>
                    </div>
                    <div class="mb-3">
                        <label for="type" class="form-label">Type</label>
                        <input type="text" class="form-control" id="type" required>
                    </div>
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <input type="text" class="form-control" id="status" required>
                    </div>
                    <div class="mb-3">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="location" required>
                    </div>
                    <div class="mb-3">
                        <label for="pincode" class="form-label">Pincode</label>
                        <input type="number" class="form-control" id="pincode" required>
                    </div>
                    <div class="mb-3">
                        <label for="latitude" class="form-label">Latitude</label>
                        <input type="number" step="0.0001" class="form-control" id="latitude" required>
                    </div>
                    <div class="mb-3">
                        <label for="longitude" class="form-label">Longitude</label>
                        <input type="number" step="0.0001" class="form-control" id="longitude" required>
                    </div>
                    <div class="mb-3">
                        <label for="power_reading" class="form-label">Power Reading</label>
                        <input type="number" step="0.01" class="form-control" id="power_reading" required>
                    </div>
                    <div class="mb-3">
                        <label for="fuel_reading" class="form-label">Fuel Reading</label>
                        <input type="number" step="0.01" class="form-control" id="fuel_reading" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Tower</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Fetch tower details from the API and display them in the table
    async function fetchTowerDetails() {
        try {
            const response = await fetch('http://localhost:8083/api/towers');
            const towers = await response.json();
            const tableBody = document.getElementById('towerTableBody');

            towers.forEach(tower => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${tower.tower_id}</td>
                    <td>${tower.height}</td>
                    <td>${tower.type}</td>
                    <td>${tower.status}</td>
                    <td>${tower.location}</td>
                    <td>${tower.pincode}</td>
                    <td>${tower.latitude}</td>
                    <td>${tower.longitude}</td>
                    <td>${tower.power_reading}</td>
                    <td>${tower.fuel_reading}</td>
                    <td>${new Date(tower.created_at).toLocaleString()}</td>
                    <td>${new Date(tower.updated_at).toLocaleString()}</td>
                    <td>${new Date(tower.last_maintained).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-warning mb-2" onclick="editTower(${tower.tower_id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTower(${tower.tower_id})">Delete</button>
                    </td>
                `;

                tableBody.appendChild(row);
            });
        } catch (error) {
            console.error('Error fetching tower details:', error);
        }
    }

    // Open the modal and pre-fill the form with tower details
    function editTower(towerId) {
        fetch(`http://localhost:8083/api/towers/${towerId}`)
            .then(response => response.json())
            .then(tower => {
                document.getElementById('editTowerId').value = tower.tower_id;
                document.getElementById('editHeight').value = tower.height;
                document.getElementById('editType').value = tower.type;
                document.getElementById('editStatus').value = tower.status;
                document.getElementById('editLocation').value = tower.location;
                document.getElementById('editPincode').value = tower.pincode;
                document.getElementById('editLatitude').value = tower.latitude;
                document.getElementById('editLongitude').value = tower.longitude;
                document.getElementById('editPowerReading').value = tower.power_reading;
                document.getElementById('editFuelReading').value = tower.fuel_reading;

                // Show the modal
                const editModal = new bootstrap.Modal(document.getElementById('editTowerModal'));
                editModal.show();
            })
            .catch(error => console.error('Error fetching tower details:', error));
    }

    // Function to handle adding a new tower
    document.getElementById('addTowerForm').addEventListener('submit', function (e) {
        e.preventDefault();
        let newTower = {
            height: document.getElementById('height').value,
            type: document.getElementById('type').value,
            status: document.getElementById('status').value,
            location: document.getElementById('location').value,
            pincode: document.getElementById('pincode').value,
            latitude: document.getElementById('latitude').value,
            longitude: document.getElementById('longitude').value,
            power_reading: document.getElementById('power_reading').value,
            fuel_reading: document.getElementById('fuel_reading').value,
            deletedStatus: false
        };

        fetch('http://localhost:8083/api/towers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(newTower)
        }).then(response => {
            if (response.ok) {
                fetchTowerDetails();
                const addModal = bootstrap.Modal.getInstance(document.getElementById('addTowerModal'));
                addModal.hide();
            } else {
                alert('Failed to add tower');
            }
        });
    });

    document.getElementById('editTowerForm').addEventListener('submit', async function(event) {
        event.preventDefault();

        const towerId = document.getElementById('editTowerId').value;
        const updatedTower = {
            height: document.getElementById('editHeight').value,
            type: document.getElementById('editType').value,
            status: document.getElementById('editStatus').value,
            location: document.getElementById('editLocation').value,
            pincode: document.getElementById('editPincode').value,
            latitude: document.getElementById('editLatitude').value,
            longitude: document.getElementById('editLongitude').value,
            power_reading: document.getElementById('editPowerReading').value,
            fuel_reading: document.getElementById('editFuelReading').value,
        };

        try {
            const response = await fetch(`http://localhost:8083/api/towers/${towerId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedTower)
            });

            if (response.ok) {
                alert('Tower details updated successfully');
                
                // Close the modal
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editTowerModal'));
                editModal.hide();

                // Clear the table before reloading data
                document.getElementById('towerTableBody').innerHTML = '';

                // Reload the tower list to show updated data
                fetchTowerDetails();
            } else {
                alert('Failed to update tower details');
            }
        } catch (error) {
            console.error('Error updating tower details:', error);
        }
    });

    // Function to handle deleting a tower
    function deleteTower(towerId) {
        if (confirm('Are you sure you want to delete this tower?')) {
            fetch(`http://localhost:8083/api/towers/delete/${towerId}`, {
                method: 'DELETE'
            }).then(response => {
                if (response.ok) {
                    alert('Tower deleted successfully');
                    
                    // Clear the table before reloading data
                    document.getElementById('towerTableBody').innerHTML = '';

                    // Reload the tower list to show updated data
                    fetchTowerDetails();
                } else {
                    alert('Failed to delete tower');
                }
            }).catch(error => console.error('Error deleting tower:', error));
        }
    }

    // Call the function when the page loads
    window.onload = fetchTowerDetails;
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
